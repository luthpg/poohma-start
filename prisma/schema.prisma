// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// 1. データソース設定: PostgreSQL (Cloud SQL)
datasource db {
  provider = "postgresql"
}

// 2. クライアント生成: JavaScript/TypeScript用
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

// ------------------------------------------------------
// Enums
// ------------------------------------------------------

// 公開範囲設定
enum Visibility {
  PRIVATE // 自分のみ閲覧・編集可能
  SHARED // 家族全員が閲覧・編集可能
}

// ------------------------------------------------------
// Models
// ------------------------------------------------------

/**
 * 家族グループ
 * ユーザーが所属し、情報を共有する単位。
 */
model Family {
  id        String   @id @default(uuid()) // UUID v4
  name      String   @db.VarChar(100) // 家族名（例: 田中家）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users          User[]
  serviceRecords ServiceRecord[]

  @@map("families") // DBテーブル名は複数形・小文字
}

/**
 * ユーザー
 * Firebase Authのユーザーと1対1で対応。
 */
model User {
  id          String  @id // Firebase Authentication の UID を直接使用 (UUIDではない)
  email       String  @unique
  displayName String? @map("display_name")

  // 所属する家族 (Optional: 未所属の状態もあり得るため)
  familyId String? @map("family_id")
  family   Family? @relation(fields: [familyId], references: [id])

  // Relations
  serviceRecords ServiceRecord[] // 自分が作成したレコード

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

/**
 * サービスレコード
 * アカウント情報の親となるエンティティ（例: Netflix, Amazon）。
 */
model ServiceRecord {
  id String @id @default(uuid())

  // 基本情報
  title          String  @db.VarChar(255)
  url            String? @db.Text // サービスURL
  ogpImage       String? @map("ogp_image_url") @db.Text // OGP画像URL
  ogpDescription String? @map("ogp_description") @db.Text // OGP説明文
  memo           String? @db.Text // 自由記述メモ

  // 権限・所有設定
  visibility Visibility @default(PRIVATE)

  // 所有者 (作成者)
  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id])

  // 共有先家族 (検索高速化と権限チェック用)
  // visibility = SHARED の場合、この familyId が必須となるロジックをアプリ側で実装
  familyId String? @map("family_id")
  family   Family? @relation(fields: [familyId], references: [id])

  // Relations
  credentials AccountCredential[] // ID/ヒントのリスト
  tags        RecordTag[] // タグリスト

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Indexes: ダッシュボードでの検索クエリを高速化
  @@index([userId])
  @@index([familyId, visibility])
  @@map("service_records")
}

/**
 * アカウント情報 (IDとヒント)
 * 1つのサービスに対して複数のIDを登録可能（例: 父用、母用）。
 */
model AccountCredential {
  id String @id @default(uuid())

  label        String? @db.VarChar(100) // ラベル (例: パパ用)
  loginId      String? @map("login_id") @db.VarChar(255)
  passwordHint String? @map("password_hint") @db.Text // パスワードではなく「ヒント」

  // 親レコード (親が消えたら道連れで削除: Cascade)
  recordId String        @map("record_id")
  record   ServiceRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("account_credentials")
}

/**
 * レコードタグ
 * ダッシュボードでのフィルタリングに使用。
 */
model RecordTag {
  id String @id @default(uuid())

  tagName String @map("tag_name") @db.VarChar(50)

  // 親レコード (親が消えたら道連れで削除: Cascade)
  recordId String        @map("record_id")
  record   ServiceRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  // 制約: 1つのレコード内で同じタグ名は重複させない
  @@unique([recordId, tagName])
  // Index: タグ名での検索・集計用
  @@index([tagName])
  @@map("record_tags")
}
